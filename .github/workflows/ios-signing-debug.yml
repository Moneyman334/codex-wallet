name: iOS Signing Debug

on:
  workflow_dispatch:

jobs:
  debug:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Decode and inspect certificate
        env:
          CERTIFICATE_BASE64: ${{ secrets.IOS_P12_BASE64 }}
          CERTIFICATE_PASSWORD: ${{ secrets.IOS_P12_PASSWORD }}
        run: |
          echo "=== Decoding certificate ==="
          echo "$CERTIFICATE_BASE64" | base64 --decode > /tmp/cert.p12
          echo "Certificate decoded to /tmp/cert.p12 ($(stat -f%z /tmp/cert.p12) bytes)"
          
          echo "=== Setting up temporary keychain ==="
          security create-keychain -p "build" build.keychain
          security default-keychain -s ~/Library/Keychains/build.keychain
          security unlock-keychain -p "build" ~/Library/Keychains/build.keychain
          
          echo "=== Importing certificate ==="
          security import /tmp/cert.p12 -k ~/Library/Keychains/build.keychain -P "$CERTIFICATE_PASSWORD" -A
          
          echo "=== Listing codesigning identities ==="
          security find-identity -p codesigning -v ~/Library/Keychains/build.keychain

      - name: Decode and inspect provisioning profile
        env:
          PROVISIONING_PROFILE_BASE64: ${{ secrets.IOS_PROV_PROFILE_BASE64 }}
        run: |
          echo "=== Decoding provisioning profile ==="
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          echo "$PROVISIONING_PROFILE_BASE64" | base64 --decode > ~/Library/MobileDevice/Provisioning\ Profiles/profile.mobileprovision
          echo "Profile decoded ($(stat -f%z ~/Library/MobileDevice/Provisioning\ Profiles/profile.mobileprovision) bytes)"
          
          echo "=== Inspecting provisioning profile ==="
          security cms -D -i ~/Library/MobileDevice/Provisioning\ Profiles/profile.mobileprovision > /tmp/prov.plist
          
          echo "Profile Name:"
          /usr/libexec/PlistBuddy -c "Print :Name" /tmp/prov.plist
          
          echo "Team Identifier:"
          /usr/libexec/PlistBuddy -c "Print :TeamIdentifier" /tmp/prov.plist
          
          echo "Application Identifier (bundle ID pattern):"
          /usr/libexec/PlistBuddy -c "Print :Entitlements:application-identifier" /tmp/prov.plist
          
          echo "Bundle Identifier:"
          /usr/libexec/PlistBuddy -c "Print :UUID" /tmp/prov.plist

      - name: Check app bundle ID in Info.plist
        run: |
          echo "=== Checking app bundle ID ==="
          if [ -f "ios/App/App/Info.plist" ]; then
            /usr/libexec/PlistBuddy -c "Print :CFBundleIdentifier" ios/App/App/Info.plist || echo "No CFBundleIdentifier found"
          else
            echo "Info.plist not found at ios/App/App/Info.plist"
          fi

      - name: Summary
        run: |
          echo "=== SUMMARY ==="
          echo "Expected Team ID: UCXFC48DX7"
          echo "Expected Bundle ID: com.getchaospay.app"
          echo ""
          echo "If the provisioning profile TeamIdentifier matches UCXFC48DX7"
          echo "and the application-identifier ends with com.getchaospay.app"
          echo "then the main build workflow should succeed."
